---
title: "Crew_WorkLoad"
format: html
editor: source
---

## Packages
```{r}

if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

# librarian downloads, if not already downloaded, and reads in needed packages
librarian::shelf(tidyverse, here, DBI, odbc, writexl)


prev_bid_period <- substr(as.character(Sys.Date() - 30), 1, 7)
```


## Pull in Reserve count 
```{r}
# Connect to the `PLAYGROUND` database and append data if necessary
tryCatch({
  db_connection_pg <- DBI::dbConnect(odbc::odbc(),  # Establish a database connection using ODBC for the playground database
                                     Driver = "SnowflakeDSIIDriver",  # Specify the Snowflake ODBC driver
                                     Server = "hawaiianair.west-us-2.azure.snowflakecomputing.com",  # Server address
                                     WAREHOUSE = "DATA_LAKE_READER",  # Specify the Snowflake warehouse
                                     Database = "PLAYGROUND",  # Specify the database name
                                     UID = "jacob.eisaguirre@hawaiianair.com",  # User ID for authentication
                                     authenticator = "externalbrowser")  # Use external browser for authentication
  print("Database Connected!")  # Print success message if connection is established
}, error = function(cond) {
  print("Unable to connect to Database.")  # Print error message if connection fails
})

# Set schema and retrieve data from `AA_FINAL_PAIRING` table
dbExecute(db_connection_pg, "USE SCHEMA CREW_ANALYTICS") 


# Queries
reserve_q <- "select * from AA_RESERVE_UTILIZATION WHERE PAIRING_DATE > '2022-12-25';"

raw_reserve <- dbGetQuery(db_connection_pg, reserve_q)

fp_q <- "select* from AA_FINAL_PAIRING WHERE PAIRING_DATE > '2022-12-25';"

raw_fp <- dbGetQuery(db_connection_pg, fp_q)

```

# Clean Final Pairing
```{r}

clean_fp <- raw_fp %>% 
  select(FLIGHT_DATE, PAIRING_POSITION, BID_PERIOD, EQUIPMENT, CREW_ID, BASE) %>% 
  filter(!EQUIPMENT == "33Y",
         BID_PERIOD >= prev_bid_period) %>% 
  mutate(PAIRING_POSITION = ifelse(PAIRING_POSITION %in% c("CA", "FO", "RO", "FA"),
                                   PAIRING_POSITION, 
                                   "FA"),
         EQUIPMENT = if_else(PAIRING_POSITION == "FA", NA, EQUIPMENT),
         BASE = if_else(BASE == "HAL", "HNL", BASE)) %>%
  group_by(FLIGHT_DATE, PAIRING_POSITION, EQUIPMENT, BASE) %>% 
  reframe(BID_PERIOD,
          n_bid = length(unique(CREW_ID))) %>% 
  distinct()
  
  

```


## Clean Reserve
```{r}

clean_reserve <- raw_reserve %>% 
  filter(TRANSACTION_CODE %in% c("RLV", "SCR", "ARC"),
         BID_PERIOD >= prev_bid_period) %>% 
  mutate(PAIRING_POSITION = ifelse(PAIRING_POSITION %in% c("CA", "FO", "RO", "FA"),
                                   PAIRING_POSITION, 
                                   "FA")) %>% 
  group_by(PAIRING_POSITION, PAIRING_DATE, EQUIPMENT, BASE) %>% 
  reframe(BID_PERIOD,
          n_reserve = n()) %>% 
  mutate(EQUIPMENT = if_else(EQUIPMENT == "NA", NA, EQUIPMENT)) %>% 
  rename(FLIGHT_DATE = PAIRING_DATE) %>% 
  distinct()


```

## Join Counts
```{r}

combined_gold <- inner_join(clean_fp, clean_reserve) %>% 
  mutate(workload = round((n_reserve/n_bid),2))

write_xlsx(combined_gold, "Z:/OperationsResourcePlanningAnalysis/Work_Load/workload_data.xlsx")


```
